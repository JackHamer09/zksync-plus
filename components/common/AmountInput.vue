<template>
  <div>
    <TokenSelectDropdown
      v-model:opened="selectTokenModalOpened"
      v-model:token-address="selectedTokenAddress"
      :loading="loading"
      :balances="balances"
    />
    <label class="amount-input-container" :class="{ focused, loading, 'has-error': !!amountError }">
      <div class="amount-input-token">
        <CommonContentLoader v-if="loading" :length="10" />
        <template v-else-if="selectedToken">
          <div class="flex items-center">
            <TokenImage class="-ml-0.5 h-5 w-5" v-bind="selectedToken" />
            <span class="ml-1 inline-block">{{ selectedToken.symbol }}</span>
          </div>
        </template>
      </div>
      <div class="amount-input-field-container">
        <input
          ref="inputElement"
          v-model="inputted"
          class="amount-input-field"
          placeholder="0"
          type="text"
          maxlength="20"
          spellcheck="false"
          :style="{ width: `${inputWidth}px` }"
        />
        <transition v-bind="TransitionOpacity(250, 150)">
          <button
            v-if="maxDecimalAmount && maxAmount !== '0'"
            type="button"
            class="amount-input-max-button"
            :class="{ 'is-max': isMaxAmount }"
            :title="isMaxAmount ? 'Max amount is set' : `Your max amount is ${maxDecimalAmount}`"
            @click.prevent="setMax"
          >
            Max
          </button>
        </transition>
      </div>
      <div class="amount-input-select-asset">
        <CommonContentLoader v-if="loading" :length="35" />
        <div
          v-else
          class="grid grid-cols-[1fr_calc(1rem_+_0.375rem)] items-center"
          @click.prevent="selectTokenModalOpened = true"
        >
          <template v-if="selectedToken">
            <span>
              Balance:
              <span class="break-all">
                {{ parseTokenAmount(selectedToken.amount, selectedToken.decimals) }}
              </span>
            </span>
          </template>
          <template v-else>Select token</template>
          <ChevronDownIcon class="ml-1.5 h-4 w-4" aria-hidden="true" />
        </div>
      </div>
      <transition v-bind="TransitionOpacity()">
        <div v-if="amountError" class="amount-input-error">
          <template v-if="amountError === 'insufficient_balance'">Insufficient balance</template>
          <template v-if="amountError === 'exceeds_max_amount'">
            Max amount is
            <button
              type="button"
              class="cursor-pointer font-medium underline underline-offset-2"
              @click.prevent="setMax"
            >
              {{ maxDecimalAmount }}
            </button>
          </template>
        </div>
        <div v-else-if="inputted" class="amount-input-note">
          <template v-if="selectedToken?.price === 'loading'">
            <CommonContentLoader class="shadow-sm" :length="15" />
          </template>
          <template v-else>
            {{ totalAmountPrice }}
          </template>
        </div>
      </transition>
    </label>
  </div>
</template>

<script lang="ts" setup>
import { computed, nextTick, ref, watch } from "vue";

import { ChevronDownIcon } from "@heroicons/vue/24/outline";
import { useFocus } from "@vueuse/core";
import { BigNumber } from "ethers";

import type { Balance } from "@/store/zksync/lite/wallet";
import type { BigNumberish } from "ethers";
import type { PropType } from "vue";

import { decimalToBigNumber, formatTokenPrice, parseTokenAmount } from "@/utils/formatters";
import { TransitionOpacity } from "@/utils/transitions";

const props = defineProps({
  modelValue: {
    type: String,
    default: "",
  },
  balances: {
    type: Array as PropType<Balance[]>,
    default: () => [],
    required: true,
  },
  tokenAddress: {
    type: String,
  },
  maxAmount: {
    type: String as PropType<BigNumberish>,
  },
  autofocus: {
    type: Boolean,
    default: false,
  },
  loading: {
    type: Boolean,
    default: false,
  },
});

const emit = defineEmits<{
  (eventName: "update:modelValue", amount: string): void;
  (eventName: "update:tokenAddress", tokenAddress?: string): void;
}>();

const selectedTokenAddress = computed({
  get: () => props.tokenAddress,
  set: (value?: string) => emit("update:tokenAddress", value),
});
const selectedToken = computed(() => {
  if (!props.balances) {
    return undefined;
  }
  return props.balances.find((e) => e.address === props.tokenAddress);
});
const selectTokenModalOpened = ref(false);

const amountError = computed(() => {
  if (!selectedToken.value) {
    return;
  }
  if (props.maxAmount && totalComputeAmount.value.gt(props.maxAmount)) {
    if (BigNumber.from(props.maxAmount).isZero()) {
      return "insufficient_balance";
    }
    return "exceeds_max_amount";
  }
  return undefined;
});

const inputElement = ref<HTMLInputElement | null>(null);
const { focused } = useFocus(inputElement, { initialValue: !!props.autofocus });
const inputWidth = ref(0);

const inputted = computed({
  get: () => props.modelValue,
  set: (value: string) => emit("update:modelValue", value.replace(/[^0-9.,]/g, "").replace(",", ".")),
});
watch([inputted, inputElement], () => {
  recalculateInputWidth();
});

const totalComputeAmount = computed(() => {
  try {
    if (!inputted.value || !selectedToken.value) {
      return BigNumber.from("0");
    }
    return decimalToBigNumber(inputted.value, selectedToken.value.decimals);
  } catch (error) {
    return BigNumber.from("0");
  }
});
const totalAmountPrice = computed(() => {
  if (!selectedToken.value || !selectedToken.value.price || selectedToken.value.price === "loading") {
    return "";
  }
  return formatTokenPrice(totalComputeAmount.value, selectedToken.value.decimals, selectedToken.value.price);
});
const maxDecimalAmount = computed(() => {
  if (!props.maxAmount || !selectedToken.value) {
    return;
  }
  return parseTokenAmount(props.maxAmount, selectedToken.value.decimals);
});
const isMaxAmount = computed(() => {
  if (!props.maxAmount) {
    return false;
  }
  return totalComputeAmount.value.eq(props.maxAmount);
});
const setMax = () => {
  if (!maxDecimalAmount.value) return;
  inputted.value = maxDecimalAmount.value;
};

const recalculateInputWidth = () => {
  inputWidth.value = 0;
  nextTick(() => {
    if (!inputElement.value) return;
    inputWidth.value = inputElement.value.scrollWidth;
  });
};
</script>

<style lang="scss" scoped>
.amount-input-container {
  @apply grid w-full gap-x-4 rounded-xl bg-gray-input p-4 transition-colors;
  grid-template-areas:
    "a b b b"
    "c c d d";
  &:not(.loading) {
    &.focused {
      @apply bg-gray-input-focus;

      .small-input-clear-button {
        @apply bg-gray-400;
      }
    }
  }
  &.has-error {
    // @apply bg-red-100;
    @apply ring-1 ring-inset ring-red-500;
  }

  .amount-input-token {
    @apply text-xl font-medium leading-[1.4] text-gray-900;
    grid-area: a / a / a / a;
  }
  .amount-input-field-container {
    grid-area: b / b / b / b;
    @apply flex flex-row-reverse items-center justify-start gap-2 overflow-hidden pl-2;

    .amount-input-max-button {
      @apply rounded bg-primary-100/50 px-1.5 py-1 text-xs font-medium uppercase text-primary-400 transition-all;
      &:not(.is-max) {
        @apply cursor-pointer hover:bg-primary-100;
      }
      &.is-max {
        @apply cursor-default bg-primary-600 text-white;
      }
    }
    .amount-input-field {
      @apply block w-max min-w-[15px] overflow-hidden border-none bg-transparent text-right text-xl font-medium outline-none placeholder:text-gray-secondary;
    }
  }
  .amount-input-select-asset,
  .amount-input-note,
  .amount-input-error {
    @apply mt-1 text-sm text-gray-secondary;
  }
  .amount-input-select-asset {
    @apply flex cursor-pointer items-center whitespace-pre-line transition-colors hover:text-gray-400 xs:w-max;
    grid-area: c / c / c / c;
  }
  .amount-input-note {
    @apply break-all;
  }
  .amount-input-note,
  .amount-input-error {
    @apply justify-self-end text-right;
    grid-area: d / d / d / d;
  }
  .amount-input-error {
    @apply break-words text-red-500;
  }
}
</style>
